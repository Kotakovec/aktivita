<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pracovní status a kalendář</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0 10px 40px;
    }
    header {
      display: flex;
      justify-content: flex-end;
      padding: 10px 0;
    }
    button#controlBtn {
      background: none;
      border: none;
      font-size: 14px;
      color: #888;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    button#controlBtn:hover {
      background-color: #ddd;
      color: #333;
    }
    #popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 300px;
    }
    #popup.show {
      display: block;
    }
    #popup input[type="password"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    #popup button {
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      background-color: #1976d2;
      color: white;
      border-radius: 5px;
      font-weight: bold;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 900;
    }
    #overlay.show {
      display: block;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: normal;
    }
    .user-section {
      background: white;
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .user-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .status {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      color: white;
      user-select: none;
      cursor: default;
    }
    .status.active {
      background-color: #4caf50;
    }
    .status.break {
      background-color: #ff9800;
    }
    .status.inactive {
      background-color: #f44336;
    }
    .status.editable {
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.2s;
    }
    .status.editable:hover {
      opacity: 1;
    }
    table.calendar {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      user-select: none;
    }
    table.calendar th,
    table.calendar td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      background: #fafafa;
    }
    table.calendar th {
      background: #e0e0e0;
    }
    td.time-cell {
      cursor: default;
      background: transparent;
      color: #333;
    }
    td.time-cell.editable {
      cursor: pointer;
      border-bottom: 1px dashed #666;
    }
  </style>
</head>
<body>

<header>
  <button id="controlBtn">control</button>
</header>

<h1>Pracovní status a kalendář</h1>

<div id="usersContainer">
  <!-- Sem se vykreslí uživatelé -->
</div>

<!-- Popup pro heslo -->
<div id="overlay"></div>
<div id="popup">
  <form id="passwordForm">
    <input type="password" id="passwordInput" placeholder="Zadej heslo" autocomplete="off" />
    <button type="submit">Ověřit</button>
  </form>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase konfigurace (tvůj config)
  const firebaseConfig = {
    apiKey: "AIzaSyAI0SM8STSA-ZLKmRYKBt13dPHmi-BY_bw",
    authDomain: "status2-ccf4d.firebaseapp.com",
    projectId: "status2-ccf4d",
    storageBucket: "status2-ccf4d.firebasestorage.app",
    messagingSenderId: "170845328997",
    appId: "1:170845328997:web:3243e6d771ae6f5c85d88c",
    measurementId: "G-E9TSV3D5K9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const users = ["Koťák", "MrTomiCZ", "JPmanOF", "kubali"];
  const defaultTimes = {
    "Po": "9:00 - 16:00",
    "Út": "9:00 - 16:00",
    "St": "9:00 - 16:00",
    "Čt": "9:00 - 16:00",
    "Pá": "9:00 - 16:00",
    "So": "9:00 - 16:00",
    "Ne": "9:00 - 16:00",
  };

  const statuses = ["active", "break", "inactive"];
  const statusLabels = {
    active: "Pracuje",
    break: "Pauza",
    inactive: "Nepracuje"
  };

  let editMode = false;

  const usersContainer = document.getElementById("usersContainer");
  const controlBtn = document.getElementById("controlBtn");
  const popup = document.getElementById("popup");
  const overlay = document.getElementById("overlay");
  const passwordForm = document.getElementById("passwordForm");
  const passwordInput = document.getElementById("passwordInput");

  // Funkce pro vykreslení jednoho uživatele
  async function renderUser(userId) {
    // Získat data z Firestore
    const docRef = db.collection("users").doc(userId);
    let doc = await docRef.get();

    let data = doc.exists ? doc.data() : null;

    if (!data) {
      data = {
        status: "active",
        times: {...defaultTimes}
      };
      await docRef.set(data);
    }

    // Vytvořit sekci uživatele
    let section = document.createElement("div");
    section.className = "user-section";
    section.id = "user-" + userId;

    // Nadpis s jménem
    let nameEl = document.createElement("div");
    nameEl.className = "user-name";
    nameEl.textContent = userId;
    section.appendChild(nameEl);

    // Status (barevný štítek)
    let statusEl = document.createElement("div");
    statusEl.className = "status " + data.status + (editMode ? " editable" : "");
    statusEl.textContent = statusLabels[data.status] || data.status;
    statusEl.title = editMode ? "Klikni pro změnu statusu" : "";
    if (editMode) {
      statusEl.addEventListener("click", () => {
        let currentIndex = statuses.indexOf(data.status);
        let nextIndex = (currentIndex + 1) % statuses.length;
        data.status = statuses[nextIndex];
        statusEl.textContent = statusLabels[data.status];
        statusEl.className = "status " + data.status + " editable";
        saveUserData(userId, data);
      });
    }
    section.appendChild(statusEl);

    // Tabulka kalendáře (dny v týdnu a časy)
    let table = document.createElement("table");
    table.className = "calendar";

    // Hlavička tabulky - dny
    let thead = document.createElement("thead");
    let headerRow = document.createElement("tr");
    ["Po", "Út", "St", "Čt", "Pá", "So", "Ne"].forEach(day => {
      let th = document.createElement("th");
      th.textContent = day;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Jeden řádek s časovými intervaly
    let tbody = document.createElement("tbody");
    let row = document.createElement("tr");
    ["Po", "Út", "St", "Čt", "Pá", "So", "Ne"].forEach(day => {
      let td = document.createElement("td");
      td.className = "time-cell" + (editMode ? " editable" : "");
      td.textContent = data.times[day] || "";
      if (editMode) {
        td.title = "Klikni pro úpravu času";
        td.addEventListener("click", () => {
          let newTime = prompt(`Zadej nový čas pro ${day}`, td.textContent);
          if (newTime !== null) {
            td.textContent = newTime.trim();
            data.times[day] = newTime.trim();
            saveUserData(userId, data);
          }
        });
      }
      row.appendChild(td);
    });
    tbody.appendChild(row);
    table.appendChild(tbody);

    section.appendChild(table);

    // Pokud uživatel už existuje v DOM, nahradíme, jinak přidáme
    let existing = document.getElementById("user-" + userId);
    if (existing) {
      usersContainer.replaceChild(section, existing);
    } else {
      usersContainer.appendChild(section);
    }
  }

  // Uložit data uživatele do Firestore
  async function saveUserData(userId, data) {
    try {
      await db.collection("users").doc(userId).set(data);
    } catch (err) {
      alert("Chyba při ukládání dat: " + err.message);
    }
  }

  // Načíst a vykreslit všechny uživatele
  async function loadAllUsers() {
    for (let userId of users) {
      await renderUser(userId);
    }
  }

  // Otevřít popup pro zadání hesla
  function openPasswordPopup() {
    passwordInput.value = "";
    popup.classList.add("show");
    overlay.classList.add("show");
    passwordInput.focus();
  }

  // Zavřít popup
  function closePasswordPopup() {
    popup.classList.remove("show");
    overlay.classList.remove("show");
  }

  // Zpracování formuláře hesla
  passwordForm.addEventListener("submit", e => {
    e.preventDefault();
    const pass = passwordInput.value.trim();
    if (pass === "frconzole24") {
      editMode = true;
      closePasswordPopup();
      loadAllUsers();
      alert("Editace povolena.");
    } else {
      alert("Špatné heslo.");
    }
  });

  // Klik na tlačítko control
  controlBtn.addEventListener("click", () => {
    openPasswordPopup();
  });

  // Klik mimo popup zavře popup
  overlay.addEventListener("click", () => {
    closePasswordPopup();
  });

  // Inicializace
  loadAllUsers();

</script>

</body>
</html>
