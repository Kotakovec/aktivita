<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Časová aktivita</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f0f0f0;
    }
    h2 {
      margin-top: 30px;
    }
    .status {
      margin-left: 15px;
    }
  </style>
</head>
<body>
  <h1>Součet stavů za dnešek (00:00–24:00)</h1>
  <div id="output">Načítám data…</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0klfrJWi5xNBF3EUkEmVVOE0F8CvjNRw",
      authDomain: "time-897fc.firebaseapp.com",
      projectId: "time-897fc",
      databaseURL: "https://time-897fc-default-rtdb.europe-west1.firebasedatabase.app",
      storageBucket: "time-897fc.appspot.com",
      messagingSenderId: "420987750968",
      appId: "1:420987750968:web:240c4462bad41137f6b4cd",
      measurementId: "G-W3WVS2FM3D"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const output = document.getElementById("output");

    function msToHMS(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }

    function processHistory(data) {
      const today = new Date();
      const dateStr = today.toISOString().split("T")[0]; // např. "2025-07-24"
      let html = "";

      for (const user in data) {
        const logs = data[user][dateStr];
        if (!logs) continue;

        const statusDurations = {
          Active: 0,
          Break: 0,
          Inactive: 0
        };

        const sortedLogs = logs.sort((a, b) => a.timestamp - b.timestamp);
        for (let i = 0; i < sortedLogs.length; i++) {
          const current = sortedLogs[i];
          const next = sortedLogs[i + 1];
          const endTime = next ? next.timestamp : new Date().getTime();
          const duration = endTime - current.timestamp;
          statusDurations[current.status] += duration;
        }

        html += `<h2>${user}</h2>`;
        for (const [status, time] of Object.entries(statusDurations)) {
          html += `<div class="status">${status}: ${msToHMS(time)}</div>`;
        }
      }

      output.innerHTML = html || "Žádná data pro dnešní den.";
    }

    db.ref("statusHistory").once("value")
      .then(snapshot => {
        const data = snapshot.val();
        processHistory(data);
      })
      .catch(error => {
        output.innerText = "Chyba při načítání dat: " + error.message;
      });
  </script>
</body>
</html>